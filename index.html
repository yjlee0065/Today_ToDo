<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Today To-Do Final Fix</title>
    <style>
        :root { 
            --bg: #ffffff; 
            --text-main: #37352f; 
            --text-gray: #555; 
            --accent-mint: #B2DFDB; 
            --border-soft: #f1f1f0;
            --warning-red: #ff6b6b;
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            display: flex; flex-direction: column; align-items: center; 
            background: var(--bg); margin: 0; padding: 15px; user-select: none; color: var(--text-main);
        }
        #main-widget { display: flex; flex-direction: column; align-items: center; width: 100%; position: relative; }
        
        #reset-btn {
            position: absolute; top: -10px; left: 0; 
            background: none; border: none; padding: 4px 8px;
            font-size: 1.2rem; cursor: pointer; color: #787774;
            line-height: 1; z-index: 10;
        }

        #canvas-container { 
            position: relative; width: 200px; height: 200px; 
            margin-bottom: 25px; filter: drop-shadow(0 4px 10px rgba(0, 0, 0, 0.1));
        }
        
        .info-panel { 
            text-align: center; padding: 10px 15px; border-radius: 12px;
            background: #ffffff; border: 1px solid var(--border-soft);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); width: 170px; overflow: hidden;
        }
        
        .current-time { 
            color: var(--accent-mint); font-weight: 800; font-size: 1.2rem; 
            display: inline-block; margin-bottom: 4px; white-space: nowrap;
        }

        .marquee-container { width: 100%; overflow: hidden; white-space: nowrap; position: relative; }
        .current-task { display: inline-block; font-size: 0.95rem; color: var(--text-gray); font-weight: 700; }

        .scrolling { display: inline-block; padding-left: 100%; animation: marquee 7s linear infinite; }
        @keyframes marquee { 0% { transform: translate(0, 0); } 100% { transform: translate(-100%, 0); } }

        /* 모달 공통 스타일 */
        .modal-style {
            display: none; position: fixed; top: 50%; left: 50%; 
            transform: translate(-50%, -50%); background: white; 
            padding: 20px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); 
            z-index: 1000; width: 230px; border: 1px solid var(--border-soft); 
        }

        .input-row { display: flex; justify-content: center; gap: 8px; margin: 15px 0; }
        select { padding: 8px; border-radius: 6px; border: 1px solid #ddd; outline: none; background: #fff; }
        
        .setup-row { display: flex; align-items: center; justify-content: center; gap: 5px; margin-bottom: 15px; font-weight: bold; }
        .setup-row select { width: 65px; padding: 5px; }

        input[type="text"] { width: 100%; padding: 12px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; font-size: 0.95rem; outline: none; }
        .save-btn { width: 100%; background: #444; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: opacity 0.2s; }
        .save-btn:active { opacity: 0.8; }
        #setup-screen { text-align: center; padding-top: 40px; }
    </style>
</head>
<body>

<div id="setup-screen">
    <h2 style="color: #555; margin-bottom: 25px;">Today To-Do</h2>
    <div class="setup-row">
        <span>시작</span>
        <select id="start-ampm"><option value="0">오전</option><option value="12" selected>오후</option></select>
        <select id="start-h"></select>
        <select id="start-m"></select>
    </div>
    <div class="setup-row">
        <span>종료</span>
        <select id="end-ampm"><option value="0">오전</option><option value="12" selected>오후</option></select>
        <select id="end-h"></select>
        <select id="end-m"></select>
    </div>
    <button class="save-btn" onclick="initChart()" style="width: auto; padding: 10px 30px; background: var(--accent-mint); color: #333; margin-top: 10px;">Start Planning</button>
</div>

<div id="main-widget" style="display:none;">
    <button id="reset-btn" onclick="openResetModal()" title="초기화">⟳</button>
    <div id="canvas-container">
        <canvas id="plannerCanvas" width="200" height="200"></canvas>
    </div>
    <div class="info-panel">
        <div id="display-time" class="current-time">--:-- ~ --:--</div>
        <div class="marquee-container">
            <div id="display-task" class="current-task">일과 없음</div>
        </div>
    </div>
</div>

<div id="modal" class="modal-style">
    <h4 style="margin: 0 0 15px 0; text-align: center;">일과 설정</h4>
    <div class="input-row">
        <select id="h-select" style="width: 85px;">
            <option value="0" selected>0h</option> 
            <option value="1">1h</option><option value="2">2h</option><option value="3">3h</option><option value="4">4h</option>
            <option value="5">5h</option><option value="6">6h</option><option value="7">7h</option><option value="8">8h</option>
        </select>
        <select id="m-select" style="width: 85px;">
            <option value="0" selected>0m</option>
            <option value="15">15m</option>
            <option value="30">30m</option>
            <option value="45">45m</option>
        </select>
    </div>
    <input type="text" id="task-in" placeholder="할 일 입력">
    <button class="save-btn" onclick="handleSave()">저장</button>
    <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button id="del-btn" onclick="deleteTask()" style="flex: 1; background: none; border: none; color: var(--warning-red); cursor: pointer; font-size: 0.85rem;">삭제</button>
        <button onclick="closeModal()" style="flex: 1; background: none; border: none; color: #999; cursor: pointer; font-size: 0.85rem;">취소</button>
    </div>
</div>

<div id="reset-modal" class="modal-style">
    <h4 style="margin: 0 0 10px 0; text-align: center;">초기화하시겠습니까?</h4>
    <p style="font-size: 0.85rem; color: #888; text-align: center; margin-bottom: 20px;">모든 일과 데이터가 삭제됩니다.</p>
    <div style="display: flex; gap: 10px;">
        <button class="save-btn" onclick="confirmReset()" style="flex: 1; background: var(--warning-red);">초기화</button>
        <button class="save-btn" onclick="closeResetModal()" style="flex: 1; background: #eee; color: #444;">취소</button>
    </div>
</div>

<div id="alert-modal" class="modal-style">
    <h4 style="margin: 0 0 10px 0; text-align: center; color: var(--warning-red);">시간 초과</h4>
    <p id="alert-msg" style="font-size: 0.9rem; color: #555; text-align: center; margin-bottom: 20px; line-height: 1.4;"></p>
    <button class="save-btn" onclick="closeAlertModal()" style="background: #eee; color: #444;">확인</button>
</div>

<script>
    let startTime, endTime, totalMin, tasks = [], editingIdx = -1, dragIdx = -1, isDragging = false, startX, startY;
    const canvas = document.getElementById('plannerCanvas'), ctx = canvas.getContext('2d');
    const colorPalette = ['#D4DDF4', '#D4E9F8', '#D8F4FB', '#DDD4F0', '#F0D7F1'];
    let mouse = { x: 0, y: 0, overIdx: -1 };

    function populateSetupSelects() {
        const hSelects = [document.getElementById('start-h'), document.getElementById('end-h')];
        const mSelects = [document.getElementById('start-m'), document.getElementById('end-m')];
        hSelects.forEach(s => {
            for(let i=1; i<=12; i++) {
                let opt = document.createElement('option');
                opt.value = (i === 12) ? 0 : i;
                opt.text = String(i).padStart(2, '0');
                if(i === 9 && s.id === 'start-h') opt.selected = true;
                if(i === 9 && s.id === 'end-h') opt.selected = true;
                s.add(opt);
            }
        });
        mSelects.forEach(s => {
            for(let i=0; i<60; i+=5) {
                let opt = document.createElement('option');
                opt.value = i; opt.text = String(i).padStart(2, '0');
                s.add(opt);
            }
        });
    }

    function saveToLocal() {
        const data = { startTime, endTime, totalMin, tasks };
        localStorage.setItem('todayTodoData', JSON.stringify(data));
    }

    function loadFromLocal() {
        const saved = localStorage.getItem('todayTodoData');
        if (saved) {
            const data = JSON.parse(saved);
            startTime = data.startTime; endTime = data.endTime;
            totalMin = data.totalMin; tasks = data.tasks;
            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('main-widget').style.display = 'flex';
            render();
        }
    }

    function initChart() {
        const sh = (parseInt(document.getElementById('start-h').value) + parseInt(document.getElementById('start-ampm').value));
        const sm = parseInt(document.getElementById('start-m').value);
        const eh = (parseInt(document.getElementById('end-h').value) + parseInt(document.getElementById('end-ampm').value));
        const em = parseInt(document.getElementById('end-m').value);
        startTime = sh * 60 + sm; endTime = eh * 60 + em;
        if(endTime <= startTime) endTime += 1440;
        totalMin = endTime - startTime;
        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('main-widget').style.display = 'flex';
        saveToLocal(); render();
    }

    function openResetModal() { document.getElementById('reset-modal').style.display = 'block'; }
    function closeResetModal() { document.getElementById('reset-modal').style.display = 'none'; }
    function confirmReset() {
        tasks = []; localStorage.removeItem('todayTodoData');
        closeResetModal();
        document.getElementById('setup-screen').style.display = 'block';
        document.getElementById('main-widget').style.display = 'none';
    }

    function openAlertModal(remain) {
        document.getElementById('alert-msg').innerHTML = `전체 설정 시간을 초과했습니다.<br>설정 가능한 시간: <b>${remain}분</b> 남음`;
        document.getElementById('alert-modal').style.display = 'block';
    }
    function closeAlertModal() { document.getElementById('alert-modal').style.display = 'none'; }

    function render() {
        ctx.clearRect(0,0,200,200);
        const cx=100, cy=100, r=95;
        ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI*2);
        ctx.fillStyle = '#fff'; ctx.fill();
        let curA = -Math.PI/2;
        tasks.forEach((t, i) => {
            const sweep = (t.dur / totalMin) * Math.PI*2;
            ctx.beginPath(); ctx.moveTo(cx, cy);
            ctx.arc(cx, cy, r, curA, curA + sweep);
            ctx.fillStyle = (dragIdx === i) ? '#f5f5f5' : colorPalette[i % colorPalette.length];
            ctx.fill();
            ctx.strokeStyle = 'rgba(255,255,255,0.7)'; ctx.lineWidth = 1.5; ctx.stroke();
            t.startA = curA; t.endA = curA + sweep;
            curA += sweep;
        });
        ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI*2);
        ctx.strokeStyle = '#ffffff'; ctx.lineWidth = 3; ctx.stroke();
        const now = new Date(), nowMin = now.getHours()*60 + now.getMinutes();
        const relativeNow = (nowMin < startTime && endTime > 1440) ? nowMin + 1440 : nowMin;
        if(relativeNow >= startTime && relativeNow <= endTime) {
            const angle = ((relativeNow-startTime)/totalMin)*Math.PI*2 - Math.PI/2;
            ctx.beginPath(); ctx.moveTo(cx, cy); ctx.lineTo(cx+Math.cos(angle)*r, cy+Math.sin(angle)*r);
            ctx.strokeStyle = '#B2DFDB'; ctx.lineWidth = 2.5; ctx.stroke();
            ctx.beginPath(); ctx.arc(cx, cy, 3, 0, Math.PI*2); ctx.fillStyle = '#B2DFDB'; ctx.fill();
        }
        if(mouse.overIdx === -1 && Math.sqrt((mouse.x-100)**2 + (mouse.y-100)**2) < 95) {
            if(tasks.reduce((s,t)=>s+t.dur,0) < totalMin) {
                ctx.fillStyle = "rgba(178, 223, 219, 0.4)"; ctx.font = "bold 24px sans-serif";
                ctx.textAlign = "center"; ctx.fillText("+", mouse.x, mouse.y + 8);
            }
        }
        updateInfo(relativeNow);
        requestAnimationFrame(render);
    }

    canvas.addEventListener('mousemove', e => {
        const rect = canvas.getBoundingClientRect();
        mouse.x = e.clientX - rect.left; mouse.y = e.clientY - rect.top;
        const dx = mouse.x - 100, dy = mouse.y - 100;
        let angle = Math.atan2(dy, dx); if(angle < -Math.PI/2) angle += Math.PI*2;
        mouse.overIdx = tasks.findIndex(t => angle >= t.startA && angle < t.endA);
        if(isDragging && dragIdx !== -1 && mouse.overIdx !== -1 && mouse.overIdx !== dragIdx) {
            const item = tasks.splice(dragIdx, 1)[0]; tasks.splice(mouse.overIdx, 0, item); dragIdx = mouse.overIdx;
            saveToLocal();
        }
    });

    canvas.addEventListener('mousedown', e => { startX = e.clientX; startY = e.clientY; if(mouse.overIdx !== -1) { dragIdx = mouse.overIdx; isDragging = true; } });
    window.addEventListener('mouseup', e => {
        const d = Math.sqrt((e.clientX - startX)**2 + (e.clientY - startY)**2);
        if(d < 5 && Math.sqrt((mouse.x-100)**2 + (mouse.y-100)**2) < 95) openEdit(mouse.overIdx);
        isDragging = false; dragIdx = -1;
    });

    function openEdit(idx) {
        editingIdx = idx;
        document.getElementById('del-btn').style.visibility = idx === -1 ? "hidden" : "visible";
        document.getElementById('h-select').value = idx === -1 ? 0 : Math.floor(tasks[idx].dur/60);
        document.getElementById('m-select').value = idx === -1 ? 0 : (Math.floor(tasks[idx].dur % 60 / 15) * 15);
        document.getElementById('task-in').value = idx === -1 ? "" : tasks[idx].name;
        document.getElementById('modal').style.display = 'block';
    }

    function handleSave() {
        const h = parseInt(document.getElementById('h-select').value);
        const m = parseInt(document.getElementById('m-select').value);
        const d = (h * 60) + m;
        if(d <= 0) return;
        
        const used = tasks.reduce((s, t, i) => s + (i === editingIdx ? 0 : t.dur), 0);
        const remain = totalMin - used;
        
        if(d > remain) {
            openAlertModal(remain);
            return;
        }
        
        const n = document.getElementById('task-in').value || "일과";
        if(editingIdx > -1) tasks[editingIdx] = { dur: d, name: n }; else tasks.push({ dur: d, name: n });
        saveToLocal(); closeModal();
    }
    
    function deleteTask() { if(editingIdx > -1) tasks.splice(editingIdx, 1); saveToLocal(); closeModal(); }
    function closeModal() { document.getElementById('modal').style.display = 'none'; }

    function updateInfo(m) {
        let c = 0, f = false;
        const timeEl = document.getElementById('display-time');
        const taskEl = document.getElementById('display-task');
        tasks.forEach(t => {
            const s = startTime + c, e = s + t.dur;
            if(m >= s && m < e) {
                timeEl.innerText = `${fmt(s)} ~ ${fmt(e)}`;
                if(taskEl.innerText !== t.name) { taskEl.innerText = t.name; checkScroll(); }
                f = true;
            }
            c += t.dur;
        });
        if(!f) { 
            timeEl.innerText = "--:-- ~ --:--"; 
            if(taskEl.innerText !== "일과 없음") { taskEl.innerText = "일과 없음"; checkScroll(); }
        }
    }

    function checkScroll() {
        const taskEl = document.getElementById('display-task');
        const container = taskEl.parentElement;
        taskEl.classList.remove('scrolling');
        if (taskEl.offsetWidth > container.offsetWidth) { taskEl.classList.add('scrolling'); }
    }
    function fmt(m) { return `${String(Math.floor(m/60)%24).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`; }

    populateSetupSelects();
    loadFromLocal();
</script>
</body>
</html>
