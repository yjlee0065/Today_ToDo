<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notion Planner Widget v2</title>
    <style>
        :root { --bg: #ffffff; --text: #333; --accent: #d44c47; }
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; background: var(--bg); margin: 0; padding: 20px; user-select: none; }
        #canvas-container { position: relative; width: 320px; height: 320px; cursor: crosshair; }
        canvas { border-radius: 50%; }
        .info-panel { margin-top: 25px; text-align: center; min-height: 80px; }
        .current-time { color: var(--accent); font-weight: bold; font-size: 1.4rem; margin-bottom: 8px; }
        .current-task { font-size: 1.2rem; color: var(--text); font-weight: 500; }
        
        /* 모달 레이아웃 */
        #modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); z-index: 1000; width: 260px; }
        .input-row { display: flex; justify-content: center; gap: 15px; margin: 15px 0; }
        .num-ctrl { display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .num-ctrl input { width: 55px; text-align: center; font-size: 1.1rem; padding: 5px; border: 1px solid #ddd; border-radius: 5px; }
        .arrow-btn { cursor: pointer; background: #f5f5f5; border: 1px solid #ddd; width: 30px; height: 25px; border-radius: 4px; }
        input[type="text"] { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 15px; }
        .save-btn { width: 100%; background: #333; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        #setup-screen { text-align: center; padding: 50px; }
    </style>
</head>
<body>

<div id="setup-screen">
    <h2 style="margin-bottom:20px;">전체 시간 범위 설정</h2>
    <input type="time" id="start-time" value="09:00"> ~ 
    <input type="time" id="end-time" value="21:00">
    <br><br>
    <button class="save-btn" onclick="initChart()">위젯 생성하기</button>
</div>

<div id="main-widget" style="display:none;">
    <div id="canvas-container">
        <canvas id="plannerCanvas" width="320" height="320"></canvas>
    </div>
    <div class="info-panel">
        <div id="display-time" class="current-time">00:00 ~ 00:00</div>
        <div id="display-task" class="current-task">현재 일과가 없습니다.</div>
    </div>
</div>

<div id="modal">
    <h3 id="modal-title" style="margin-top:0;">일과 추가/수정</h3>
    <div class="input-row">
        <div class="num-ctrl">
            <button class="arrow-btn" onclick="adj(1,0)">▲</button>
            <input type="number" id="h-in" value="1">
            <button class="arrow-btn" onclick="adj(-1,0)">▼</button>
            <small>시간</small>
        </div>
        <div class="num-ctrl">
            <button class="arrow-btn" onclick="adj(0,15)">▲</button>
            <input type="number" id="m-in" value="0">
            <button class="arrow-btn" onclick="adj(0,-15)">▼</button>
            <small>분</small>
        </div>
    </div>
    <input type="text" id="task-in" placeholder="할 일을 입력하세요">
    <button class="save-btn" onclick="handleSave()">저장</button>
    <button onclick="closeModal()" style="width:100%; background:none; border:none; color:#888; margin-top:10px; cursor:pointer;">취소</button>
</div>

<script>
    let startTime, endTime, totalMin;
    let tasks = [];
    let editingIndex = -1;
    let draggingIndex = -1;
    const canvas = document.getElementById('plannerCanvas');
    const ctx = canvas.getContext('2d');
    const colors = ['#C5B4E3', '#B2E2E2', '#F9E4B7', '#F8BBD0', '#C8E6C9'];
    let mouse = { x: 0, y: 0, overEmpty: false };

    function initChart() {
        const s = document.getElementById('start-time').value.split(':');
        const e = document.getElementById('end-time').value.split(':');
        startTime = parseInt(s[0])*60 + parseInt(s[1]);
        endTime = parseInt(e[0])*60 + parseInt(e[1]);
        if(endTime <= startTime) endTime += 1440;
        totalMin = endTime - startTime;
        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('main-widget').style.display = 'flex';
        loop();
    }

    function adj(h, m) {
        const hi = document.getElementById('h-in'), mi = document.getElementById('m-in');
        let curH = parseInt(hi.value), curM = parseInt(mi.value);
        curH += h; curM += m;
        if(curM >= 60) { curH++; curM = 0; }
        if(curM < 0) { curH--; curM = 45; }
        const currentDur = (curH * 60) + curM;
        const used = tasks.reduce((s, t, i) => s + (i === editingIndex ? 0 : t.dur), 0);
        if(currentDur > (totalMin - used)) { alert("남은 시간을 초과했습니다!"); return; }
        hi.value = Math.max(0, curH); mi.value = Math.max(0, curM);
    }

    function loop() {
        ctx.clearRect(0,0,320,320);
        const cx=160, cy=160, r=150;
        
        // 외곽선
        ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI*2);
        ctx.strokeStyle = '#333'; ctx.lineWidth = 3; ctx.stroke();

        let curA = -Math.PI/2;
        tasks.forEach((t, i) => {
            const sweep = (t.dur / totalMin) * Math.PI*2;
            ctx.beginPath(); ctx.moveTo(cx, cy); ctx.arc(cx, cy, r, curA, curA + sweep);
            ctx.fillStyle = colors[i % colors.length]; ctx.fill();
            ctx.stroke();
            t.startA = curA; t.endA = curA + sweep;
            curA += sweep;
        });

        // 현재 시간 침
        const now = new Date();
        const nowMin = now.getHours()*60 + now.getMinutes();
        if(nowMin >= startTime && nowMin <= endTime) {
            const angle = ((nowMin-startTime)/totalMin)*Math.PI*2 - Math.PI/2;
            ctx.beginPath(); ctx.moveTo(cx, cy);
            ctx.lineTo(cx+Math.cos(angle)*r, cy+Math.sin(angle)*r);
            ctx.strokeStyle = '#d44c47'; ctx.lineWidth = 3; ctx.stroke();
        }

        // 마우스 추적 '+' 표시 (빈 공간일 때만)
        if(mouse.overEmpty) {
            ctx.fillStyle = "rgba(0,0,0,0.2)"; ctx.font = "30px Arial";
            ctx.textAlign = "center"; ctx.fillText("+", mouse.x, mouse.y + 10);
        }

        updateUI(nowMin);
        requestAnimationFrame(loop);
    }

    function updateUI(nowMin) {
        let cum = 0; let found = false;
        tasks.forEach(t => {
            const s = startTime + cum, e = s + t.dur;
            if(nowMin >= s && nowMin < e) {
                document.getElementById('display-time').innerText = `${fmt(s)} ~ ${fmt(e)}`;
                document.getElementById('display-task').innerText = t.name;
                found = true;
            }
            cum += t.dur;
        });
        if(!found) { 
            document.getElementById('display-time').innerText = "--:-- ~ --:--";
            document.getElementById('display-task').innerText = "진행 중인 일과 없음";
        }
    }

    function fmt(m) { return `${String(Math.floor(m/60)%24).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`; }

    canvas.addEventListener('mousemove', e => {
        const rect = canvas.getBoundingClientRect();
        mouse.x = e.clientX - rect.left; mouse.y = e.clientY - rect.top;
        const dx = mouse.x - 160, dy = mouse.y - 160;
        const dist = Math.sqrt(dx*dx + dy*dy);
        const angle = Math.atan2(dy, dx);
        const normalizedA = angle < -Math.PI/2 ? angle + Math.PI*2 : angle;

        let inTask = false;
        tasks.forEach((t, i) => { if(normalizedA >= t.startA && normalizedA < t.endA) inTask = true; });
        mouse.overEmpty = dist < 150 && !inTask;
    });

    canvas.addEventListener('mousedown', e => {
        const dx = mouse.x - 160, dy = mouse.y - 160;
        const angle = Math.atan2(dy, dx);
        const normalizedA = angle < -Math.PI/2 ? angle + Math.PI*2 : angle;
        
        const idx = tasks.findIndex(t => normalizedA >= t.startA && normalizedA < t.endA);
        if(idx !== -1) {
            if(e.shiftKey) { // 드래그 시작 (Shift 누르고 드래그 시 순서 변경)
                draggingIndex = idx;
            } else { // 수정 모달
                editingIndex = idx;
                document.getElementById('h-in').value = Math.floor(tasks[idx].dur/60);
                document.getElementById('m-in').value = tasks[idx].dur%60;
                document.getElementById('task-in').value = tasks[idx].name;
                document.getElementById('modal').style.display = 'block';
            }
        } else if(mouse.overEmpty) {
            editingIndex = -1;
            document.getElementById('task-in').value = "";
            document.getElementById('modal').style.display = 'block';
        }
    });

    // 드래그 순서 변경 로직
    canvas.addEventListener('mouseup', e => {
        if(draggingIndex !== -1) {
            const dx = mouse.x - 160, dy = mouse.y - 160;
            const angle = Math.atan2(dy, dx);
            const normalizedA = angle < -Math.PI/2 ? angle + Math.PI*2 : angle;
            const targetIdx = tasks.findIndex(t => normalizedA >= t.startA && normalizedA < t.endA);
            if(targetIdx !== -1 && targetIdx !== draggingIndex) {
                const item = tasks.splice(draggingIndex, 1)[0];
                tasks.splice(targetIdx, 0, item);
            }
            draggingIndex = -1;
        }
    });

    function handleSave() {
        const dur = parseInt(document.getElementById('h-in').value)*60 + parseInt(document.getElementById('m-in').value);
        const name = document.getElementById('task-in').value || "일과";
        if(editingIndex > -1) tasks[editingIndex] = { dur, name };
        else tasks.push({ dur, name });
        closeModal();
    }

    function closeModal() { document.getElementById('modal').style.display = 'none'; }
</script>
</body>
</html>
